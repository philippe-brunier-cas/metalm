---
title: "Data Preparation "
subtitle: "metalm"
author: "philippe.brunier@cogne.com"
version: 1.0 
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    css: ./custom.css
    df_print: paged
    gallery: no
    highlight: default
    html_document: null
    lightbox: yes
    number_sections: yes
    self_contained: yes
    thumbnails: no
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      fig.height = 7,
                      fig.width = 10,
                      collapse = TRUE,
                      cols.print=20)
rm(list = ls(all.names = TRUE))

require(dplyr)
require(kableExtra)
require(readr)
require(reticulate)
source('~/dev/metalm/R/function.R')
```

# Creazione del database

Viene creato un database che racchiude le informazioni riassunte per sk. 
E' composto come segue:

+ tempo limite (usura)
+ forza prima passata (usura)
+ forza di picco (usura)
+ chimiche di prodotto 
+ prove meccaniche (trazioni, durezze)

(la mappatura è coerente con le tabelle precedenti) 

```{python join dei dati, include = TRUE}

import pandas as pd
import numpy as np

file_mach = 'database_opt.csv'
file_ox = 'tabella_ox.txt'
file_wear = 'tool_wear.txt'
file_met = 'metallurgical.csv'

def ReadFile(filename):
  df = pd.read_csv(file_mach,sep='|',na_values='na')
  df = df[df.sk!='na']



df_mach = pd.read_csv(file_mach,sep='|',na_values='na')
df_ox = pd.read_csv(file_ox,sep='|',na_values='na')
df_wear = pd.read_csv(file_wear,sep='|',na_values='na')
df_met = pd.read_csv(file_met,sep='|',na_values='na')
df_met = df_met[df_met.SK!='na']

# dal momento che raggruppo per schede, e 
# che alcuni df hanno dati ripetuti, faccio un prepocessing
# raggruppando per SK. sk sarà il mio nuovo indice per i join
# carico tutto in dfw

#df_wear
dfw = df_wear.groupby('sk').mean()
dfs = df_wear.groupby('sk').std()
dfc = df_wear.groupby('sk').count()

dfw[['std_F0','std_Fmax','std_wear_time']] = dfs[['F0','Fmax','wear_time']]
dfw['wear_count'] = dfc['F0']

#df_ox
dfo = df_ox.groupby('sk').mean()
dfs = df_ox.groupby('sk').std()
dfc = df_ox.groupby('sk').count()

dfw[['AL2O3_mean','SIO2_mean','CAO_mean']] = dfo[['AL2O3_i','SIO2_i','CAO_i']]
# dfm['metallurgical_count'] = dfc['col']

dfw['dF_perc'] = (dfw.Fmax-dfw.F0)/dfw.F0*100

#df_met
dfm = df_met.groupby('sk').mean()
dfs = df_met.groupby('sk').std()
dfc = df_met.groupby('sk').count()

features = ['C', 'S', 'P', 'SI', 'MN', 'CR', 'NI', 'MO', 'CU','SN', 'V','W', 'CO', 'TI', 'NB', 'N2', 'O2 ', 'area','k2_OA', 'k2_OS', 'k2_OG','k3_OA', 'k3_OS', 'k3_OG', 'As', 'Ag', 'Affs', 'Bs', 'Bg', 'Bffs', 'Cs','Cg', 'Cffs', 'Ds', 'Dg', 'Dffs', 'rm_[Mpa]', 'rp_02_[Mpa]']

dfw[features] = dfm[features]


dfw = dfw.reset_index()
dfw['Fmax/F0'] = dfw.Fmax/dfw.F0
dfw['dF'] = dfw['Fmax/F0'] - 1

# allaccio i materiali
mat = []
for i in range(0,len(dfw.col)):
    mat.append(np.unique(df_wear[df_wear.col==dfw.col[i]].materiale.values)[0])

dfw['materiale'] = mat
dfw = dfw.dropna()


#salvo i dati come csv
dfw.to_csv('dbmm.csv',sep='|',index=False)

```

dal file *database_opt.csv* estraiamo:

+ i valori delle differenze medie di energia

```{r aserty}

```

+ la tripla ottimale

```{r qwerty}

```


uniamo queste due informazioni al database precedente

```{r zerty}

```

contiamo le righe 

```{r serty}

```

salvo il database come .pkl
```{python xerty}
"""
save as pkl
print df.head()
"""
```

